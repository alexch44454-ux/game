<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>–ê—ç—Ä–æ—Ö–æ–∫–∫–µ–π - Telegram Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            height: 100dvh; /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ viewport */
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        .game-container {
            text-align: center;
            width: 100%;
            max-width: 100%;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh; /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ viewport –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            max-height: 100vh;
            max-height: 100dvh;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .score-board {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
            padding: 0 5px;
        }
        
        @media (max-width: 480px) {
            .score-board {
                font-size: 12px;
                margin-bottom: 1px;
                padding: 0 3px;
            }
        }
        
        .player-score {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        @media (max-width: 480px) {
            .player-score {
                padding: 3px 8px;
                border-radius: 6px;
            }
        }
        
        .game-status {
            margin: 2px 0;
            font-size: 11px;
            min-height: 15px;
            flex-shrink: 0;
            padding: 0 5px;
        }
        
        @media (max-width: 480px) {
            .game-status {
                font-size: 10px;
                margin: 1px 0;
                padding: 0 3px;
            }
        }
        
        .canvas-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
            width: 100%;
            overflow: hidden;
            position: relative;
            padding: 2px;
        }
        
        @media (max-width: 480px) {
            .canvas-wrapper {
                padding: 1px;
            }
        }
        
        #gameCanvas {
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: #0a1929;
            display: block;
            touch-action: none;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
            max-width: 100%;
            max-height: 100%;
            width: auto !important;
            height: auto !important;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        @media (max-width: 480px) {
            #gameCanvas {
                border-radius: 6px;
                border-width: 1px;
            }
        }
        
        .controls {
            margin-top: 3px;
            display: flex;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
            flex-shrink: 0;
            padding: 0 5px 3px 5px;
        }
        
        @media (max-width: 480px) {
            .controls {
                margin-top: 2px;
                gap: 3px;
                padding: 0 3px 2px 3px;
            }
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 4px 10px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        
        @media (max-width: 480px) {
            .btn {
                padding: 3px 8px;
                font-size: 10px;
                border-radius: 6px;
            }
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .waiting-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }
        
        .waiting-message {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .game-over-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }
        
        .game-over-content {
            background: rgba(30, 60, 114, 0.95);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        @media (max-width: 480px) {
            .game-over-content {
                padding: 20px;
                border-radius: 15px;
            }
        }
        
        .game-over-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        @media (max-width: 480px) {
            .game-over-title {
                font-size: 24px;
                margin-bottom: 15px;
            }
        }
        
        .game-over-result {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        @media (max-width: 480px) {
            .game-over-result {
                font-size: 18px;
                margin-bottom: 15px;
            }
        }
        
        .game-over-score {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        @media (max-width: 480px) {
            .game-over-score {
                padding: 15px;
                margin: 15px 0;
            }
        }
        
        .score-item {
            text-align: center;
        }
        
        .score-label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        @media (max-width: 480px) {
            .score-label {
                font-size: 12px;
            }
        }
        
        .score-value {
            font-size: 36px;
            font-weight: bold;
        }
        
        @media (max-width: 480px) {
            .score-value {
                font-size: 28px;
            }
        }
        
        .game-over-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        @media (max-width: 480px) {
            .game-over-buttons {
                gap: 8px;
                margin-top: 15px;
            }
        }
        
        .game-over-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            width: 100%;
        }
        
        @media (max-width: 480px) {
            .game-over-btn {
                padding: 10px 20px;
                font-size: 14px;
                border-radius: 10px;
            }
        }
        
        .game-over-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .game-over-btn:active {
            transform: translateY(0);
        }
        
        .game-over-btn.primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .game-over-btn.primary:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
        }
    </style>
</head>
<body>
    <div class="waiting-overlay hidden" id="waitingOverlay">
        <div class="waiting-message" id="waitingMessage">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</div>
        <div class="spinner"></div>
    </div>
    
    <div class="game-over-overlay hidden" id="gameOverOverlay">
        <div class="game-over-content">
            <div class="game-over-title" id="gameOverTitle">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</div>
            <div class="game-over-result" id="gameOverResult">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
            <div class="game-over-score">
                <div class="score-item">
                    <div class="score-label" id="player1LabelFinal">–í—ã</div>
                    <div class="score-value" id="finalScore1">0</div>
                </div>
                <div class="score-item">
                    <div style="font-size: 24px; opacity: 0.5;">:</div>
                </div>
                <div class="score-item">
                    <div class="score-label" id="player2LabelFinal">–°–æ–ø–µ—Ä–Ω–∏–∫</div>
                    <div class="score-value" id="finalScore2">0</div>
                </div>
            </div>
            <div class="game-over-buttons">
                <button class="game-over-btn primary" onclick="restartGame()">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                <button class="game-over-btn" onclick="closeGameOver()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="score-board">
            <div class="player-score">
                <div id="player1Label">–í—ã</div>
                <div id="player1Score">0</div>
            </div>
            <div class="player-score">
                <div id="player2Label">–°–æ–ø–µ—Ä–Ω–∏–∫</div>
                <div id="player2Score">0</div>
            </div>
        </div>
        
        <div class="game-status" id="gameStatus">–ì–æ—Ç–æ–≤ –∫ –∏–≥—Ä–µ</div>
        
        <div class="canvas-wrapper">
            <canvas id="gameCanvas" width="400" height="600"></canvas>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="resetGame()">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
            <button class="btn" onclick="inviteFriend()">üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>
        </div>
    </div>

    <script>
        // Telegram WebApp API
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let telegramUser = null;
        let gameSessionId = null;
        let isPlayer1 = true;
        let isMultiplayer = false;
        let isBotMode = false; // –†–µ–∂–∏–º –∏–≥—Ä—ã –ø—Ä–æ—Ç–∏–≤ –±–æ—Ç–∞
        let isLocalMultiplayer = false; // –†–µ–∂–∏–º –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –æ–¥–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
        let botDifficulty = 0.7; // –°–ª–æ–∂–Ω–æ—Å—Ç—å –±–æ—Ç–∞ (0.0 - –ª–µ–≥–∫–æ, 1.0 - —Å–ª–æ–∂–Ω–æ)
        
        if (tg?.initDataUnsafe?.user) {
            telegramUser = tg.initDataUnsafe.user;
        }
        
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // –ë–∞–∑–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã (–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑–º–µ—Ä—ã –∏–≥—Ä—ã)
        const BASE_WIDTH = 400;
        const BASE_HEIGHT = 600;
        let scale = 1;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ canvas –ø–æ–¥ —ç–∫—Ä–∞–Ω
        function resizeCanvas() {
            const wrapper = document.querySelector('.canvas-wrapper');
            if (!wrapper) return;
            
            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã —ç–∫—Ä–∞–Ω–∞
            const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
            const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é –≤—ã—Å–æ—Ç—É —Å —É—á–µ—Ç–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            const scoreBoard = document.querySelector('.score-board');
            const status = document.querySelector('.game-status');
            const controls = document.querySelector('.controls');
            
            const scoreBoardHeight = scoreBoard ? scoreBoard.offsetHeight : 35;
            const statusHeight = status ? status.offsetHeight : 18;
            const controlsHeight = controls ? controls.offsetHeight : 35;
            const padding = 5;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
            const availableHeight = viewportHeight - scoreBoardHeight - statusHeight - controlsHeight - padding;
            const availableWidth = Math.min(wrapper.clientWidth - padding, viewportWidth - padding);
            
            // –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–±, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
            const scaleX = availableWidth / BASE_WIDTH;
            const scaleY = availableHeight / BASE_HEIGHT;
            scale = Math.min(scaleX, scaleY, 1.2); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–±
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas
            const canvasWidth = BASE_WIDTH * scale;
            const canvasHeight = BASE_HEIGHT * scale;
            
            canvas.style.width = canvasWidth + 'px';
            canvas.style.height = canvasHeight + 'px';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            canvas.width = BASE_WIDTH;
            canvas.height = BASE_HEIGHT;
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            ctx.setTransform(1, 0, 0, 1, 0, 0);
        }
        
        // –†–∞–∑–º–µ—Ä—ã —Å—Ç–æ–ª–∞ (–ª–æ–≥–∏—á–µ—Å–∫–∏–µ, –Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –º–∞—Å—à—Ç–∞–±–∞)
        const tableWidth = BASE_WIDTH;
        const tableHeight = BASE_HEIGHT;
        const goalWidth = 100;
        const goalHeight = 20;
        const goalY1 = 0; // –í–µ—Ä—Ö–Ω–∏–π –≥–æ–ª
        const goalY2 = tableHeight - goalHeight; // –ù–∏–∂–Ω–∏–π –≥–æ–ª
        const goalX = (tableWidth - goalWidth) / 2;
        
        // –ò–≥—Ä–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã
        let puck = {
            x: tableWidth / 2,
            y: tableHeight / 2,
            radius: 15,
            vx: 0,
            vy: 0,
            speed: 0
        };
        
        let player1 = {
            x: tableWidth / 2,
            y: tableHeight - 80,
            radius: 25,
            vx: 0,
            vy: 0,
            prevX: tableWidth / 2,
            prevY: tableHeight - 80
        };
        
        let player2 = {
            x: tableWidth / 2,
            y: 80,
            radius: 25,
            vx: 0,
            vy: 0,
            prevX: tableWidth / 2,
            prevY: 80
        };
        
        // –°—á–µ—Ç
        let score1 = 0;
        let score2 = 0;
        const maxScore = 7;
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameRunning = false;
        let lastUpdate = Date.now();
        let syncInterval = null;
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∞–Ω–∏–π/–º—ã—à–∏
        let touchPos = null;
        let activeTouches = new Map(); // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Å–∞–Ω–∏–π –¥–ª—è —Ä–µ–∂–∏–º–∞ –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤
        
        canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
        canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
        canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
        canvas.addEventListener('touchcancel', handleTouchEnd, { passive: false });
        canvas.addEventListener('mousedown', handleMouseDown);
        canvas.addEventListener('mousemove', handleMouseMove);
        canvas.addEventListener('mouseup', handleMouseUp);
        canvas.addEventListener('mouseleave', handleMouseUp);
        
        function handleTouchStart(e) {
            e.preventDefault();
            e.stopPropagation();
            const rect = canvas.getBoundingClientRect();
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –Ω–æ–≤—ã–µ –∫–∞—Å–∞–Ω–∏—è
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                const touchId = touch.identifier;
                const x = (touch.clientX - rect.left) / scale;
                const y = (touch.clientY - rect.top) / scale;
                
                if (isLocalMultiplayer) {
                    // –†–µ–∂–∏–º –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤: –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–æ–Ω—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Å–∞–Ω–∏–µ
                    const isTopHalf = y < tableHeight / 2;
                    activeTouches.set(touchId, { x, y, isTopHalf });
                    updatePlayerPositionLocal({ x, y }, isTopHalf);
                } else {
                    // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤–æ–µ –∫–∞—Å–∞–Ω–∏–µ
                    if (activeTouches.size === 0) {
                        activeTouches.set(touchId, { x, y });
                        touchPos = { x, y };
                        updatePlayerPosition(touchPos);
                    }
                }
            }
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            e.stopPropagation();
            const rect = canvas.getBoundingClientRect();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Å–∞–Ω–∏–π
            for (let i = 0; i < e.touches.length; i++) {
                const touch = e.touches[i];
                const touchId = touch.identifier;
                const x = (touch.clientX - rect.left) / scale;
                const y = (touch.clientY - rect.top) / scale;
                
                if (isLocalMultiplayer) {
                    // –†–µ–∂–∏–º –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤: –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Å–∞–Ω–∏–µ
                    const isTopHalf = y < tableHeight / 2;
                    const existingTouch = activeTouches.get(touchId);
                    if (existingTouch) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–æ–Ω—É, –µ—Å–ª–∏ –∫–∞—Å–∞–Ω–∏–µ –ø–µ—Ä–µ—à–ª–æ –≥—Ä–∞–Ω–∏—Ü—É
                        existingTouch.x = x;
                        existingTouch.y = y;
                        existingTouch.isTopHalf = isTopHalf;
                        updatePlayerPositionLocal({ x, y }, isTopHalf);
                    } else {
                        // –ù–æ–≤–æ–µ –∫–∞—Å–∞–Ω–∏–µ
                        activeTouches.set(touchId, { x, y, isTopHalf });
                        updatePlayerPositionLocal({ x, y }, isTopHalf);
                    }
                } else {
                    // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º: –æ–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–µ –∫–∞—Å–∞–Ω–∏–µ
                    if (activeTouches.has(touchId)) {
                        touchPos = { x, y };
                        updatePlayerPosition(touchPos);
                    }
                }
            }
        }
        
        function handleTouchEnd(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // –£–¥–∞–ª—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∫–∞—Å–∞–Ω–∏—è
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                activeTouches.delete(touch.identifier);
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ä–µ–∂–∏–º –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤, –æ—á–∏—â–∞–µ–º touchPos
            if (!isLocalMultiplayer) {
                if (activeTouches.size === 0) {
                    touchPos = null;
                }
            }
        }
        
        function handleMouseDown(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / scale;
            const y = (e.clientY - rect.top) / scale;
            
            if (isLocalMultiplayer) {
                // –†–µ–∂–∏–º –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤: –∏—Å–ø–æ–ª—å–∑—É–µ–º mouseId = -1
                const isTopHalf = y < tableHeight / 2;
                activeTouches.set(-1, { x, y, isTopHalf });
                updatePlayerPositionLocal({ x, y }, isTopHalf);
            } else {
                touchPos = { x, y };
                updatePlayerPosition(touchPos);
            }
        }
        
        function handleMouseMove(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / scale;
            const y = (e.clientY - rect.top) / scale;
            
            if (isLocalMultiplayer) {
                // –†–µ–∂–∏–º –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤: –æ–±–Ω–æ–≤–ª—è–µ–º –º—ã—à—å
                if (activeTouches.has(-1)) {
                    const isTopHalf = y < tableHeight / 2;
                    activeTouches.set(-1, { x, y, isTopHalf });
                    updatePlayerPositionLocal({ x, y }, isTopHalf);
                }
            } else {
                if (touchPos) {
                    touchPos = { x, y };
                    updatePlayerPosition(touchPos);
                }
            }
        }
        
        function handleMouseUp(e) {
            e.preventDefault();
            if (isLocalMultiplayer) {
                activeTouches.delete(-1);
            } else {
                touchPos = null;
            }
        }
        
        function updatePlayerPosition(pos) {
            if (!gameRunning) return;
            
            const player = isPlayer1 ? player1 : player2;
            const targetX = Math.max(player.radius, Math.min(tableWidth - player.radius, pos.x));
            const targetY = isPlayer1 
                ? Math.max(tableHeight / 2, Math.min(tableHeight - player.radius, pos.y))
                : Math.max(player.radius, Math.min(tableHeight / 2, pos.y));
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
            const dt = 0.016; // ~60 FPS
            player.vx = (targetX - player.x) / dt;
            player.vy = (targetY - player.y) / dt;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
            player.prevX = player.x;
            player.prevY = player.y;
            
            player.x = targetX;
            player.y = targetY;
            
            // –ü–æ–∑–∏—Ü–∏—è –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ gameLoop
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –æ–¥–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
        function updatePlayerPositionLocal(pos, isTopHalf) {
            if (!gameRunning) return;
            
            // isTopHalf = true -> player2 (–≤–µ—Ä—Ö–Ω–∏–π), false -> player1 (–Ω–∏–∂–Ω–∏–π)
            const player = isTopHalf ? player2 : player1;
            
            const targetX = Math.max(player.radius, Math.min(tableWidth - player.radius, pos.x));
            const targetY = isTopHalf
                ? Math.max(player.radius, Math.min(tableHeight / 2 - player.radius, pos.y))
                : Math.max(tableHeight / 2, Math.min(tableHeight - player.radius, pos.y));
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞
            const dt = 0.016; // ~60 FPS
            player.vx = (targetX - player.x) / dt;
            player.vy = (targetY - player.y) / dt;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
            player.prevX = player.x;
            player.prevY = player.y;
            
            player.x = targetX;
            player.y = targetY;
        }
        
        // –§–∏–∑–∏–∫–∞
        function updatePhysics() {
            if (!gameRunning) return;
            
            const dt = 0.016; // ~60 FPS
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —à–∞–π–±—ã
            puck.x += puck.vx * dt;
            puck.y += puck.vy * dt;
            
            // –¢—Ä–µ–Ω–∏–µ (—É–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è)
            puck.vx *= 0.995;
            puck.vy *= 0.995;
            
            // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å - —à–∞–π–±–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
            const minSpeed = 150; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —à–∞–π–±—ã
            const currentSpeed = Math.sqrt(puck.vx * puck.vx + puck.vy * puck.vy);
            
            if (currentSpeed < minSpeed) {
                // –ï—Å–ª–∏ —Å–∫–æ—Ä–æ—Å—Ç—å —Å–ª–∏—à–∫–æ–º –º–∞–ª–∞, –ø—Ä–∏–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
                if (currentSpeed < 10) {
                    // –ï—Å–ª–∏ —à–∞–π–±–∞ –ø–æ—á—Ç–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å, –¥–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    const angle = Math.random() * Math.PI * 2;
                    puck.vx = Math.cos(angle) * minSpeed;
                    puck.vy = Math.sin(angle) * minSpeed;
                } else {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ –º–∏–Ω–∏–º—É–º–∞
                    const speedMultiplier = minSpeed / currentSpeed;
                    puck.vx *= speedMultiplier;
                    puck.vy *= speedMultiplier;
                }
            }
            
            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –±–æ—Ä—Ç–∞–º–∏
            if (puck.x - puck.radius <= 0 || puck.x + puck.radius >= tableWidth) {
                puck.vx = -puck.vx * 0.8;
                puck.x = Math.max(puck.radius, Math.min(tableWidth - puck.radius, puck.x));
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Å–ª–µ –æ—Ç—Å–∫–æ–∫–∞ –æ—Ç –±–æ–∫–æ–≤—ã—Ö –±–æ—Ä—Ç–æ–≤
                const speedAfterBounce = Math.sqrt(puck.vx * puck.vx + puck.vy * puck.vy);
                if (speedAfterBounce < minSpeed) {
                    const speedMultiplier = minSpeed / speedAfterBounce;
                    puck.vx *= speedMultiplier;
                    puck.vy *= speedMultiplier;
                }
            }
            
            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –≤–µ—Ä—Ö–Ω–∏–º/–Ω–∏–∂–Ω–∏–º –±–æ—Ä—Ç–æ–º (–∫—Ä–æ–º–µ –≤–æ—Ä–æ—Ç)
            if (puck.y - puck.radius <= goalY1 + goalHeight && puck.x >= goalX && puck.x <= goalX + goalWidth) {
                // –í –æ–±–ª–∞—Å—Ç–∏ –≤–æ—Ä–æ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            } else if (puck.y - puck.radius <= 0) {
                puck.vy = -puck.vy * 0.8;
                puck.y = puck.radius;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Å–ª–µ –æ—Ç—Å–∫–æ–∫–∞ –æ—Ç –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–æ—Ä—Ç–∞
                const speedAfterBounce = Math.sqrt(puck.vx * puck.vx + puck.vy * puck.vy);
                if (speedAfterBounce < minSpeed) {
                    const speedMultiplier = minSpeed / speedAfterBounce;
                    puck.vx *= speedMultiplier;
                    puck.vy *= speedMultiplier;
                }
            }
            
            if (puck.y + puck.radius >= goalY2 && puck.x >= goalX && puck.x <= goalX + goalWidth) {
                // –í –æ–±–ª–∞—Å—Ç–∏ –≤–æ—Ä–æ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            } else if (puck.y + puck.radius >= tableHeight) {
                puck.vy = -puck.vy * 0.8;
                puck.y = tableHeight - puck.radius;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Å–ª–µ –æ—Ç—Å–∫–æ–∫–∞ –æ—Ç –Ω–∏–∂–Ω–µ–≥–æ –±–æ—Ä—Ç–∞
                const speedAfterBounce = Math.sqrt(puck.vx * puck.vx + puck.vy * puck.vy);
                if (speedAfterBounce < minSpeed) {
                    const speedMultiplier = minSpeed / speedAfterBounce;
                    puck.vx *= speedMultiplier;
                    puck.vy *= speedMultiplier;
                }
            }
            
            // –ì–æ–ª—ã
            if (puck.y - puck.radius <= goalY1 + goalHeight && 
                puck.x >= goalX && puck.x <= goalX + goalWidth) {
                score2++;
                resetPuck();
                updateScore();
                if (score2 >= maxScore) {
                    endGame(false);
                }
            }
            
            if (puck.y + puck.radius >= goalY2 && 
                puck.x >= goalX && puck.x <= goalX + goalWidth) {
                score1++;
                resetPuck();
                updateScore();
                if (score1 >= maxScore) {
                    endGame(true);
                }
            }
            
            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –∏–≥—Ä–æ–∫–∞–º–∏
            checkCollision(puck, player1);
            checkCollision(puck, player2);
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º (–µ—Å–ª–∏ —Ä–µ–∂–∏–º –ø—Ä–æ—Ç–∏–≤ –±–æ—Ç–∞ –∏ –Ω–µ –ª–æ–∫–∞–ª—å–Ω—ã–π –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä)
            if (isBotMode && !isLocalMultiplayer && gameRunning) {
                updateBotAI();
            }
        }
        
        // –ò–ò –¥–ª—è –±–æ—Ç–∞
        function updateBotAI() {
            // –ë–æ—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç player2 (–≤–µ—Ä—Ö–Ω–∏–π –∏–≥—Ä–æ–∫)
            const bot = player2;
            const target = puck;
            const dt = 0.016; // ~60 FPS
            
            // –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —à–∞–π–±—ã
            const predictionTime = 0.3; // –í—Ä–µ–º—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
            let predictedX = target.x + target.vx * predictionTime;
            let predictedY = target.y + target.vy * predictionTime;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ —Å—Ç–æ–ª–∞
            predictedX = Math.max(target.radius, Math.min(tableWidth - target.radius, predictedX));
            predictedY = Math.max(target.radius, Math.min(tableHeight / 2 - target.radius, predictedY));
            
            // –ï—Å–ª–∏ —à–∞–π–±–∞ –¥–≤–∏–∂–µ—Ç—Å—è –∫ –≤–æ—Ä–æ—Ç–∞–º –±–æ—Ç–∞ (–≤–≤–µ—Ä—Ö), –±–æ—Ç –∑–∞—â–∏—â–∞–µ—Ç—Å—è
            if (target.vy < 0 || target.y < tableHeight / 2) {
                // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–ª–µ–≤—É—é –ø–æ–∑–∏—Ü–∏—é —Å —É—á–µ—Ç–æ–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                const reactionSpeed = 0.3 + botDifficulty * 0.5; // –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏ –±–æ—Ç–∞
                
                // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
                const smoothingFactor = 0.15 + botDifficulty * 0.1; // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è (0.15-0.25)
                
                // –í—ã—á–∏—Å–ª—è–µ–º –∂–µ–ª–∞–µ–º—É—é –ø–æ–∑–∏—Ü–∏—é
                const desiredX = predictedX;
                const desiredY = predictedY;
                
                // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫ –∂–µ–ª–∞–µ–º–æ–π –ø–æ–∑–∏—Ü–∏–∏
                const dx = desiredX - bot.x;
                const dy = desiredY - bot.y;
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è –±–æ—Ç–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
                const maxSpeed = 300 + botDifficulty * 200; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 0) {
                    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    const dirX = dx / distance;
                    const dirY = dy / distance;
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è (–ø–ª–∞–≤–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º)
                    const moveSpeed = Math.min(distance * smoothingFactor, maxSpeed * dt);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–ª–∞–≤–Ω–æ
                    bot.x += dirX * moveSpeed;
                    bot.y += dirY * moveSpeed;
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –±–æ—Ç–∞ –µ–≥–æ –∑–æ–Ω–æ–π
                const minX = bot.radius;
                const maxX = tableWidth - bot.radius;
                const minY = bot.radius;
                const maxY = tableHeight / 2 - bot.radius;
                
                bot.x = Math.max(minX, Math.min(maxX, bot.x));
                bot.y = Math.max(minY, Math.min(maxY, bot.y));
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏ (–º–µ–Ω—å—à–µ –Ω–∞ –≤—ã—Å–æ–∫–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏)
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ –∫ –Ω–µ–±–æ–ª—å—à–æ–º—É —Å–º–µ—â–µ–Ω–∏—é, –∞ –Ω–µ –∫ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é
                const randomness = (1 - botDifficulty) * 2;
                if (randomness > 0 && Math.random() < 0.1) { // –¢–æ–ª—å–∫–æ 10% –≤—Ä–µ–º–µ–Ω–∏
                    bot.x += (Math.random() - 0.5) * randomness;
                    bot.y += (Math.random() - 0.5) * randomness;
                    bot.x = Math.max(minX, Math.min(maxX, bot.x));
                    bot.y = Math.max(minY, Math.min(maxY, bot.y));
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –±–æ—Ç–∞ –¥–ª—è —Ñ–∏–∑–∏–∫–∏ (–ø–ª–∞–≤–Ω–æ)
                bot.vx = (bot.x - bot.prevX) / dt;
                bot.vy = (bot.y - bot.prevY) / dt;
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
                const speed = Math.sqrt(bot.vx * bot.vx + bot.vy * bot.vy);
                if (speed > maxSpeed) {
                    bot.vx = (bot.vx / speed) * maxSpeed;
                    bot.vy = (bot.vy / speed) * maxSpeed;
                }
                
                bot.prevX = bot.x;
                bot.prevY = bot.y;
            } else {
                // –ï—Å–ª–∏ —à–∞–π–±–∞ –¥–∞–ª–µ–∫–æ, –±–æ—Ç –ø–ª–∞–≤–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Ü–µ–Ω—Ç—Ä —Å–≤–æ–µ–π –∑–æ–Ω—ã
                const centerX = tableWidth / 2;
                const centerY = 80;
                const returnSpeed = 0.08; // –£–º–µ–Ω—å—à–µ–Ω–∞ –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
                
                const dx = centerX - bot.x;
                const dy = centerY - bot.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 5) { // –ï—Å–ª–∏ –Ω–µ –≤ —Ü–µ–Ω—Ç—Ä–µ
                    const dirX = dx / distance;
                    const dirY = dy / distance;
                    const moveSpeed = Math.min(distance * returnSpeed, 200 * dt);
                    
                    bot.x += dirX * moveSpeed;
                    bot.y += dirY * moveSpeed;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –ø–ª–∞–≤–Ω–æ
                bot.vx = (bot.x - bot.prevX) / dt;
                bot.vy = (bot.y - bot.prevY) / dt;
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
                const speed = Math.sqrt(bot.vx * bot.vx + bot.vy * bot.vy);
                if (speed > 200) {
                    bot.vx = (bot.vx / speed) * 200;
                    bot.vy = (bot.vy / speed) * 200;
                }
                
                bot.prevX = bot.x;
                bot.prevY = bot.y;
            }
        }
        
        function checkCollision(puck, player) {
            const dx = puck.x - player.x;
            const dy = puck.y - player.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const minDistance = puck.radius + player.radius;
            
            if (distance < minDistance) {
                // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
                const nx = dx / distance;
                const ny = dy / distance;
                
                // –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ
                const overlap = minDistance - distance;
                puck.x += nx * overlap * 0.5;
                puck.y += ny * overlap * 0.5;
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞ (–¥–ª—è –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ —É–¥–∞—Ä–∞)
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –∏–≥—Ä–æ–∫–∞
                const playerSpeed = Math.sqrt(player.vx * player.vx + player.vy * player.vy);
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –∏–≥—Ä–æ–∫–∞ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞
                const maxPlayerSpeed = 800;
                const normalizedPlayerSpeed = Math.min(playerSpeed, maxPlayerSpeed) / maxPlayerSpeed;
                
                // –û—Ç—Å–∫–æ–∫ —Å —É—á–µ—Ç–æ–º —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–≥—Ä–æ–∫–∞
                const relativeVx = puck.vx - player.vx;
                const relativeVy = puck.vy - player.vy;
                const dot = relativeVx * nx + relativeVy * ny;
                
                if (dot < 0) {
                    // –£–≤–µ–ª–∏—á–µ–Ω–∞ —Å–∏–ª–∞ –æ—Ç—Å–∫–æ–∫–∞ –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
                    const baseBounce = 3.5; // –ë–∞–∑–æ–≤–∞—è —Å–∏–ª–∞ –æ—Ç—Å–∫–æ–∫–∞ (–±—ã–ª–æ 1.5)
                    const speedBoost = 1.0 + normalizedPlayerSpeed * 0.5; // –ë–æ–Ω—É—Å –∑–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞
                    const bounce = baseBounce * speedBoost;
                    
                    puck.vx -= dot * nx * bounce * speedBoost;
                    puck.vy -= dot * ny * bounce * speedBoost;
                    
                    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Å–ª–µ —É–¥–∞—Ä–∞ (—á—Ç–æ–±—ã —à–∞–π–±–∞ –≤—Å–µ–≥–¥–∞ –ª–µ—Ç–µ–ª–∞)
                    const minSpeedAfterHit = 300;
                    const currentSpeed = Math.sqrt(puck.vx * puck.vx + puck.vy * puck.vy);
                    if (currentSpeed < minSpeedAfterHit) {
                        const speedMultiplier = minSpeedAfterHit / currentSpeed;
                        puck.vx *= speedMultiplier;
                        puck.vy *= speedMultiplier;
                    }
                    
                    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ)
                    const maxSpeed = 1200;
                    const finalSpeed = Math.sqrt(puck.vx * puck.vx + puck.vy * puck.vy);
                    if (finalSpeed > maxSpeed) {
                        const speedMultiplier = maxSpeed / finalSpeed;
                        puck.vx *= speedMultiplier;
                        puck.vy *= speedMultiplier;
                    }
                }
            }
        }
        
        function resetPuck() {
            puck.x = tableWidth / 2;
            puck.y = tableHeight / 2;
            // –£–≤–µ–ª–∏—á–µ–Ω–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —à–∞–π–±—ã –¥–ª—è –±–æ–ª–µ–µ –¥–∏–Ω–∞–º–∏—á–Ω–æ–π –∏–≥—Ä—ã
            puck.vx = (Math.random() - 0.5) * 400;
            puck.vy = (Math.random() - 0.5) * 400;
        }
        
        function resetGame() {
            score1 = 0;
            score2 = 0;
            resetPuck();
            player1.x = tableWidth / 2;
            player1.y = tableHeight - 80;
            player1.prevX = tableWidth / 2;
            player1.prevY = tableHeight - 80;
            player1.vx = 0;
            player1.vy = 0;
            player2.x = tableWidth / 2;
            player2.y = 80;
            player2.prevX = tableWidth / 2;
            player2.prevY = 80;
            player2.vx = 0;
            player2.vy = 0;
            gameRunning = true;
            updateScore();
            
            if (isLocalMultiplayer) {
                document.getElementById('gameStatus').textContent = '–î–≤–∞ –∏–≥—Ä–æ–∫–∞ - –∏–≥—Ä–∞–π—Ç–µ –≤–º–µ—Å—Ç–µ!';
            } else if (isBotMode) {
                document.getElementById('gameStatus').textContent = '–ò–≥—Ä–∞ –ø—Ä–æ—Ç–∏–≤ –±–æ—Ç–∞!';
            } else {
                document.getElementById('gameStatus').textContent = '–ò–≥—Ä–∞ –∏–¥–µ—Ç!';
            }
        }
        
        function updateScore() {
            document.getElementById('player1Score').textContent = score1;
            document.getElementById('player2Score').textContent = score2;
        }
        
        function endGame(player1Won) {
            gameRunning = false;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∏–≥—Ä–æ–∫–∞
            let resultMessage = '';
            let resultEmoji = '';
            
            if (isLocalMultiplayer) {
                // –†–µ–∂–∏–º –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –æ–¥–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
                if (player1Won) {
                    resultMessage = '–ò–≥—Ä–æ–∫ 1 –ø–æ–±–µ–¥–∏–ª!';
                    resultEmoji = 'üèÜ';
                } else {
                    resultMessage = '–ò–≥—Ä–æ–∫ 2 –ø–æ–±–µ–¥–∏–ª!';
                    resultEmoji = 'üèÜ';
                }
            } else if (isBotMode) {
                // –†–µ–∂–∏–º –ø—Ä–æ—Ç–∏–≤ –±–æ—Ç–∞
                if (player1Won) {
                    resultMessage = 'üéâ –ü–æ–±–µ–¥–∞!';
                    resultEmoji = 'üèÜ';
                } else {
                    resultMessage = 'üòî –ü–æ—Ä–∞–∂–µ–Ω–∏–µ';
                    resultEmoji = 'üíî';
                }
            } else {
                // –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä
                if (player1Won) {
                    resultMessage = isPlayer1 ? 'üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!' : 'üòî –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏';
                    resultEmoji = isPlayer1 ? 'üèÜ' : 'üíî';
                } else {
                    resultMessage = isPlayer1 ? 'üòî –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏' : 'üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!';
                    resultEmoji = isPlayer1 ? 'üíî' : 'üèÜ';
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã
            document.getElementById('gameStatus').textContent = resultMessage;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –º–µ–Ω—é
            showGameOverMenu(player1Won, resultMessage, resultEmoji);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±–æ—Ç
            if (isMultiplayer && gameSessionId && tg?.sendData) {
                tg.sendData(JSON.stringify({
                    action: 'game_finished',
                    sessionId: gameSessionId,
                    score1: score1,
                    score2: score2
                }));
            }
        }
        
        function showGameOverMenu(player1Won, resultMessage, resultEmoji) {
            const overlay = document.getElementById('gameOverOverlay');
            const title = document.getElementById('gameOverTitle');
            const result = document.getElementById('gameOverResult');
            const finalScore1 = document.getElementById('finalScore1');
            const finalScore2 = document.getElementById('finalScore2');
            const player1Label = document.getElementById('player1LabelFinal');
            const player2Label = document.getElementById('player2LabelFinal');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            title.textContent = resultEmoji + ' ' + resultMessage;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (isLocalMultiplayer) {
                // –†–µ–∂–∏–º –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –æ–¥–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
                if (player1Won) {
                    result.textContent = 'üèÜ –ò–≥—Ä–æ–∫ 1 –ø–æ–±–µ–¥–∏–ª!';
                } else {
                    result.textContent = 'üèÜ –ò–≥—Ä–æ–∫ 2 –ø–æ–±–µ–¥–∏–ª!';
                }
            } else if (player1Won) {
                result.textContent = isPlayer1 ? '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–±–µ–¥–æ–π!' : '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø–æ–±–µ–¥–∏–ª';
            } else {
                result.textContent = isPlayer1 ? '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø–æ–±–µ–¥–∏–ª' : '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–±–µ–¥–æ–π!';
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—á–µ—Ç
            finalScore1.textContent = score1;
            finalScore2.textContent = score2;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ—Ç–∫–∏ –∏–≥—Ä–æ–∫–æ–≤
            if (isLocalMultiplayer) {
                player1Label.textContent = '–ò–≥—Ä–æ–∫ 1';
                player2Label.textContent = '–ò–≥—Ä–æ–∫ 2';
            } else if (isBotMode) {
                player1Label.textContent = '–í—ã';
                player2Label.textContent = '–ë–æ—Ç';
            } else {
                player1Label.textContent = isPlayer1 ? '–í—ã' : '–°–æ–ø–µ—Ä–Ω–∏–∫';
                player2Label.textContent = isPlayer1 ? '–°–æ–ø–µ—Ä–Ω–∏–∫' : '–í—ã';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
            overlay.classList.remove('hidden');
        }
        
        function restartGame() {
            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –º–µ–Ω—é
            document.getElementById('gameOverOverlay').classList.add('hidden');
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É
            resetGame();
        }
        
        function closeGameOver() {
            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –º–µ–Ω—é
            document.getElementById('gameOverOverlay').classList.add('hidden');
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
        function draw() {
            // –§–æ–Ω —Å—Ç–æ–ª–∞
            ctx.fillStyle = '#0a1929';
            ctx.fillRect(0, 0, tableWidth, tableHeight);
            
            // –í–∏–∑—É–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤
            if (isLocalMultiplayer) {
                // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –∑–æ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                ctx.fillStyle = 'rgba(76, 175, 80, 0.1)'; // –ó–µ–ª–µ–Ω–∞—è –∑–æ–Ω–∞ –¥–ª—è –∏–≥—Ä–æ–∫–∞ 1
                ctx.fillRect(0, tableHeight / 2, tableWidth, tableHeight / 2);
                
                ctx.fillStyle = 'rgba(33, 150, 243, 0.1)'; // –°–∏–Ω—è—è –∑–æ–Ω–∞ –¥–ª—è –∏–≥—Ä–æ–∫–∞ 2
                ctx.fillRect(0, 0, tableWidth, tableHeight / 2);
                
                // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('–ò–≥—Ä–æ–∫ 1 (–Ω–∏–∑)', tableWidth / 2, tableHeight - 20);
                ctx.fillText('–ò–≥—Ä–æ–∫ 2 (–≤–µ—Ä—Ö)', tableWidth / 2, 20);
            }
            
            // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            ctx.moveTo(0, tableHeight / 2);
            ctx.lineTo(tableWidth, tableHeight / 2);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // –í–æ—Ä–æ—Ç–∞
            ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
            ctx.fillRect(goalX, goalY1, goalWidth, goalHeight);
            ctx.fillRect(goalX, goalY2, goalWidth, goalHeight);
            
            // –û–±–≤–æ–¥–∫–∞ –≤–æ—Ä–æ—Ç
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.strokeRect(goalX, goalY1, goalWidth, goalHeight);
            ctx.strokeRect(goalX, goalY2, goalWidth, goalHeight);
            
            // –ò–≥—Ä–æ–∫ 1 (–Ω–∏–∂–Ω–∏–π)
            ctx.fillStyle = '#4CAF50';
            ctx.beginPath();
            ctx.arc(player1.x, player1.y, player1.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // –ò–≥—Ä–æ–∫ 2 (–≤–µ—Ä—Ö–Ω–∏–π)
            ctx.fillStyle = '#2196F3';
            ctx.beginPath();
            ctx.arc(player2.x, player2.y, player2.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // –®–∞–π–±–∞
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(puck.x, puck.y, puck.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        
        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            updatePhysics();
            draw();
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–∞
            if (isMultiplayer && gameRunning) {
                sendGameState();
                requestGameState();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º (–¥–ª—è –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–∞)
        let lastSyncTime = 0;
        const SYNC_INTERVAL = 50; // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥—ã–µ 50–º—Å (20 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É)
        let lastRequestTime = 0;
        const REQUEST_INTERVAL = 100; // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 100–º—Å
        
        function sendGameState() {
            if (!isMultiplayer || !gameSessionId || !gameRunning) return;
            
            const now = Date.now();
            if (now - lastSyncTime < SYNC_INTERVAL) return;
            lastSyncTime = now;
            
            const currentPlayer = isPlayer1 ? player1 : player2;
            const gameState = {
                action: 'update_game_state',
                sessionId: gameSessionId,
                player: isPlayer1 ? 1 : 2,
                playerX: currentPlayer.x,
                playerY: currentPlayer.y,
                playerVx: currentPlayer.vx,
                playerVy: currentPlayer.vy,
                puckX: puck.x,
                puckY: puck.y,
                puckVx: puck.vx,
                puckVy: puck.vy,
                score1: score1,
                score2: score2
            };
            
            if (tg?.sendData) {
                tg.sendData(JSON.stringify(gameState));
            }
        }
        
        function requestGameState() {
            if (!isMultiplayer || !gameSessionId || !gameRunning) return;
            
            const now = Date.now();
            if (now - lastRequestTime < REQUEST_INTERVAL) return;
            lastRequestTime = now;
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
            // –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π WebApp, –∫–æ—Ç–æ—Ä–∞—è –æ–±–Ω–æ–≤–∏—Ç –∏–≥—Ä—É
            if (tg?.sendData) {
                tg.sendData(JSON.stringify({
                    action: 'get_game_state',
                    sessionId: gameSessionId
                }));
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        function checkForUpdates() {
            const urlParams = new URLSearchParams(window.location.search);
            const stateParam = urlParams.get('state');
            
            if (stateParam && isMultiplayer && gameRunning) {
                try {
                    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64
                    const decodedState = atob(stateParam.replace(/-/g, '+').replace(/_/g, '/'));
                    const state = JSON.parse(decodedState);
                    receiveGameState(state);
                    
                    // –£–¥–∞–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä state –∏–∑ URL, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å –µ–≥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ
                    const newUrl = window.location.pathname + '?session=' + gameSessionId + '&player=' + (isPlayer1 ? '1' : '2');
                    window.history.replaceState({}, '', newUrl);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:', e);
                }
            }
        }
        
        function receiveGameState(state) {
            if (!isMultiplayer || !gameRunning) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ (–ø–ª–∞–≤–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è)
            if (isPlayer1 && state.player2) {
                // –ú—ã player1, –æ–±–Ω–æ–≤–ª—è–µ–º player2
                const targetX = state.player2.x;
                const targetY = state.player2.y;
                const dx = targetX - player2.x;
                const dy = targetY - player2.y;
                
                // –ü–ª–∞–≤–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä—ã–≤–∫–æ–≤
                player2.x += dx * 0.3;
                player2.y += dy * 0.3;
                player2.vx = state.player2.vx || 0;
                player2.vy = state.player2.vy || 0;
            } else if (!isPlayer1 && state.player1) {
                // –ú—ã player2, –æ–±–Ω–æ–≤–ª—è–µ–º player1
                const targetX = state.player1.x;
                const targetY = state.player1.y;
                const dx = targetX - player1.x;
                const dy = targetY - player1.y;
                
                // –ü–ª–∞–≤–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
                player1.x += dx * 0.3;
                player1.y += dy * 0.3;
                player1.vx = state.player1.vx || 0;
                player1.vy = state.player1.vy || 0;
            }
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —à–∞–π–±—É (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
            if (state.puck) {
                // –ü–ª–∞–≤–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–ª—è —à–∞–π–±—ã
                const dx = state.puck.x - puck.x;
                const dy = state.puck.y - puck.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –±–æ–ª—å—à–æ–µ, –¥–µ–ª–∞–µ–º –±–æ–ª–µ–µ —Ä–µ–∑–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                if (distance > 50) {
                    puck.x = state.puck.x;
                    puck.y = state.puck.y;
                } else {
                    puck.x += dx * 0.5;
                    puck.y += dy * 0.5;
                }
                
                puck.vx = state.puck.vx || puck.vx;
                puck.vy = state.puck.vy || puck.vy;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç
            if (state.score1 !== undefined) score1 = state.score1;
            if (state.score2 !== undefined) score2 = state.score2;
            updateScore();
        }
        
        function inviteFriend() {
            if (tg?.sendData) {
                tg.sendData(JSON.stringify({
                    action: 'invite_friend',
                    userId: telegramUser?.id
                }));
            } else {
                alert('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–≥–∞ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ Telegram');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞ —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
        // Telegram WebApp –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä—è–º—ã–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è,
        // –ø–æ—ç—Ç–æ–º—É –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        
        // –¢–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ –∫–∞–Ω–∞–ª—ã
        function handleBotMessage(messageText) {
            try {
                const message = typeof messageText === 'string' ? JSON.parse(messageText) : messageText;
                
                if (message.action === 'game_state_update') {
                    receiveGameState(message.state);
                } else if (message.action === 'game_start') {
                    gameSessionId = message.sessionId;
                    isPlayer1 = message.isPlayer1;
                    isMultiplayer = true;
                    document.getElementById('waitingOverlay').classList.add('hidden');
                    resetGame();
                } else if (message.action === 'waiting_for_player') {
                    document.getElementById('waitingMessage').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...';
                    document.getElementById('waitingOverlay').classList.remove('hidden');
                } else if (message.action === 'game_finished') {
                    // –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                    endGame(message.winner === (isPlayer1 ? 1 : 2));
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
            }
        }
        
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞ —á–µ—Ä–µ–∑ WebApp API
        // –ï—Å–ª–∏ Telegram –¥–æ–±–∞–≤–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É, —ç—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
        if (tg && tg.onEvent) {
            tg.onEvent('message', (data) => {
                if (data && data.text) {
                    handleBotMessage(data.text);
                }
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä canvas –ø–æ–¥ —ç–∫—Ä–∞–Ω
            resizeCanvas();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(resizeCanvas, 100);
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    resizeCanvas();
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø–æ—Å–ª–µ –ø–æ–≤–æ—Ä–æ—Ç–∞
                    setTimeout(resizeCanvas, 200);
                }, 100);
            });
            
            // –î–ª—è Telegram WebApp
            if (tg) {
                tg.onEvent('viewportChanged', () => {
                    setTimeout(resizeCanvas, 100);
                });
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
            const urlParams = new URLSearchParams(window.location.search);
            const session = urlParams.get('session');
            const player = urlParams.get('player');
            const bot = urlParams.get('bot'); // –†–µ–∂–∏–º –ø—Ä–æ—Ç–∏–≤ –±–æ—Ç–∞
            const stateParam = urlParams.get('state'); // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –æ—Ç –±–æ—Ç–∞
            
            if (session && player) {
                gameSessionId = session;
                isPlayer1 = player === '1';
                isMultiplayer = true;
                document.getElementById('waitingOverlay').classList.add('hidden');
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –±–æ—Ç–∞, –ø—Ä–∏–º–µ–Ω—è–µ–º –µ–≥–æ
                if (stateParam) {
                    try {
                        // –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64
                        const decodedState = atob(stateParam.replace(/-/g, '+').replace(/_/g, '/'));
                        const state = JSON.parse(decodedState);
                        receiveGameState(state);
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:', e);
                    }
                }
            } else if (bot === 'true' || bot === '1') {
                // –†–µ–∂–∏–º –∏–≥—Ä—ã –ø—Ä–æ—Ç–∏–≤ –±–æ—Ç–∞
                isBotMode = true;
                isMultiplayer = false;
                isLocalMultiplayer = false;
                isPlayer1 = true; // –ò–≥—Ä–æ–∫ –≤—Å–µ–≥–¥–∞ player1 –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç–∞
                document.getElementById('waitingOverlay').classList.add('hidden');
                document.getElementById('player2Label').textContent = '–ë–æ—Ç';
                document.getElementById('gameStatus').textContent = '–ò–≥—Ä–∞ –ø—Ä–æ—Ç–∏–≤ –±–æ—Ç–∞';
            } else if (urlParams.get('local') === 'true' || urlParams.get('local') === '1') {
                // –†–µ–∂–∏–º –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –æ–¥–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
                isLocalMultiplayer = true;
                isBotMode = false;
                isMultiplayer = false;
                isPlayer1 = true; // –ù–µ –≤–∞–∂–Ω–æ –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ
                document.getElementById('waitingOverlay').classList.add('hidden');
                document.getElementById('player1Label').textContent = '–ò–≥—Ä–æ–∫ 1';
                document.getElementById('player2Label').textContent = '–ò–≥—Ä–æ–∫ 2';
                document.getElementById('gameStatus').textContent = '–î–≤–∞ –∏–≥—Ä–æ–∫–∞ –Ω–∞ –æ–¥–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ';
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
            resetGame();
            gameLoop();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            checkForUpdates();
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–∫–∞–∂–¥—ã–µ 200–º—Å)
            setInterval(checkForUpdates, 200);
        }
        
        // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
        if (tg) {
            tg.onEvent('viewportChanged', () => {
                tg.expand();
            });
        }
        
        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>










